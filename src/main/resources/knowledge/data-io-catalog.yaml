# Nablarch Data I/O Catalog
# データバインド（data_bind）+ データフォーマット（data_format）の知識
# Version: 1.0
# Reference: https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/data_io/data_bind.html
# FQCN検証: GitHub nablarch org ソースコードで確認済み（2026-02-10）

data_bind:
  description: |
    ファイルデータ（CSV・固定長）をJava BeansやMapオブジェクトにバインドする機能。
    アノテーションでフォーマットを定義し、ObjectMapperFactory経由で読み書きする。
    data_formatより推奨される新しいAPI。
  source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/data_io/data_bind.html"
  module:
    group_id: "com.nablarch.framework"
    artifact_id: "nablarch-common-databind"
    additional:
      - artifact_id: "nablarch-fw-web-extension"
        description: "ファイルダウンロード機能使用時に追加"
  reference: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/data_io/data_bind.html"

  core_classes:
    - name: ObjectMapperFactory
      fqcn: "nablarch.common.databind.ObjectMapperFactory"
      description: "ObjectMapperインスタンスを生成するファクトリクラス。データバインドのエントリポイント"
      verified: true
      usage: |
        // Java Beansへのバインド（CSV読み込み）
        try (ObjectMapper<UserCsv> mapper = ObjectMapperFactory.create(UserCsv.class, inputStream)) {
            UserCsv user;
            while ((user = mapper.read()) != null) {
                // userオブジェクトを処理
            }
        }

        // Mapへのバインド（CSV読み込み）
        CsvDataBindConfig config = CsvDataBindConfig.DEFAULT.withHeaderTitles("名前", "年齢");
        try (ObjectMapper<Map<String, String>> mapper = ObjectMapperFactory.create(Map.class, inputStream, config)) {
            Map<String, String> row;
            while ((row = mapper.read()) != null) {
                // rowを処理
            }
        }

        // CSV書き込み
        try (ObjectMapper<UserCsv> mapper = ObjectMapperFactory.create(UserCsv.class, outputStream)) {
            mapper.write(userCsv);
        }

    - name: ObjectMapper
      fqcn: "nablarch.common.databind.ObjectMapper"
      description: "データの読み書きを行うインターフェース。read()で1件読み込み、write()で1件書き込み"
      verified: true
      methods:
        - "T read() - 1件読み込み（nullで終端）"
        - "void write(T) - 1件書き込み"
        - "void close() - リソース解放"

    - name: CsvDataBindConfig
      fqcn: "nablarch.common.databind.csv.CsvDataBindConfig"
      description: "CSVフォーマット設定。区切り文字、囲み文字、ヘッダー行有無等を指定"
      verified: true
      presets:
        - "DEFAULT - RFC4180準拠（カンマ区切り、ダブルクォート囲み）"
        - "EXCEL - Excel互換"
        - "TSV - タブ区切り"

    - name: FixedLengthDataBindConfig
      fqcn: "nablarch.common.databind.fixedlength.FixedLengthDataBindConfig"
      description: "固定長フォーマット設定。レコード長、文字セット、改行コード等を指定"
      verified: true

  annotations:
    - name: "@Csv"
      fqcn: "nablarch.common.databind.csv.Csv"
      description: "CSV形式を指定するアノテーション。Java Beansクラスに付与"
      verified: true
      attributes:
        - "type - CsvType列挙型（DEFAULT, CUSTOM）"
        - "properties - プロパティ名の配列（CSV列の順序指定）"
      example: |
        @Csv(type = Csv.CsvType.DEFAULT, properties = {"name", "age", "email"})
        public class UserCsv {
            private String name;
            private Integer age;
            private String email;
            // getter/setter
        }

    - name: "@CsvFormat"
      fqcn: "nablarch.common.databind.csv.CsvFormat"
      description: "CSVフォーマット詳細設定。@Csv(type=CUSTOM)と組み合わせて使用"
      verified: true
      attributes:
        - "fieldSeparator - フィールド区切り文字"
        - "lineSeparator - 改行文字"
        - "quote - 囲み文字"
        - "ignoreEmptyLine - 空行無視"
        - "requiredHeader - ヘッダー行有無"
        - "charset - 文字セット"
        - "emptyToNull - 空文字をnullに変換"

    - name: "@FixedLength"
      fqcn: "nablarch.common.databind.fixedlength.FixedLength"
      description: "固定長ファイル形式を指定するアノテーション"
      verified: true
      attributes:
        - "length - レコード長（バイト）"
        - "charset - 文字セット"
        - "lineSeparator - 改行コード"
        - "fillChar - パディング文字"

    - name: "@Field"
      fqcn: "nablarch.common.databind.fixedlength.Field"
      description: "固定長レコード内のフィールド定義。オフセットと長さを指定"
      verified: true
      attributes:
        - "offset - 開始位置（1始まり）"
        - "length - フィールド長（バイト）"

    - name: "@LineNumber"
      fqcn: "nablarch.common.databind.LineNumber"
      description: "論理行番号取得用マーカーアノテーション。long型フィールドに付与"

  common_patterns:
    - name: "CSVアップロード処理"
      description: "WebアプリケーションでアップロードされたCSVファイルを読み込んでDBに登録"
      example: |
        public HttpResponse upload(HttpRequest request, ExecutionContext context) {
            List<PartInfo> partInfoList = request.getPart("csvFile");
            try (ObjectMapper<UserCsv> mapper =
                     ObjectMapperFactory.create(UserCsv.class, partInfoList.get(0).getInputStream())) {
                UserCsv user;
                while ((user = mapper.read()) != null) {
                    // バリデーション
                    // DB登録
                    UniversalDao.insert(toEntity(user));
                }
            }
            return new HttpResponse("redirect:///action/upload/complete");
        }

    - name: "CSVダウンロード処理"
      description: "DB検索結果をCSVファイルとしてダウンロード"
      example: |
        public HttpResponse download(HttpRequest request, ExecutionContext context) {
            File csvFile = File.createTempFile("users", ".csv");
            try (ObjectMapper<UserCsv> mapper =
                     ObjectMapperFactory.create(UserCsv.class, new FileOutputStream(csvFile))) {
                List<UserEntity> users = UniversalDao.findAll(UserEntity.class);
                for (UserEntity user : users) {
                    mapper.write(toUserCsv(user));
                }
            }
            StreamResponse response = new StreamResponse(csvFile);
            response.setContentType("text/csv");
            response.setContentDisposition("users.csv");
            return response;
        }

    - name: "固定長ファイル読み込み"
      description: "固定長形式のデータファイルをJava Beansにバインドして読み込み"
      example: |
        @FixedLength(length = 80, charset = "MS932")
        public class FixedRecord {
            @Field(offset = 1, length = 10)
            private String code;

            @Field(offset = 11, length = 30)
            private String name;

            @Field(offset = 41, length = 40)
            private String address;
            // getter/setter
        }

    - name: "バッチでの大量データ処理"
      description: "バッチアプリケーションでCSVファイルを逐次読み込み処理"
      example: |
        public class CsvImportAction extends BatchAction<SqlRow> {
            @Override
            public DataReader<SqlRow> createReader(ExecutionContext context) {
                // CSVファイルをDataReaderとして使用
                return new ObjectMapperDataReader<>(
                    ObjectMapperFactory.create(UserCsv.class, inputStream));
            }
        }

data_format:
  description: |
    様々なデータフォーマット（固定長・可変長・JSON・XML）を統一的に扱う機能。
    フォーマット定義ファイルでレイアウトを定義し、Mapベースでデータを読み書きする。
    ※ 非推奨機能。固定長・可変長はdata_bind、XMLはJakarta XML Binding、JSONはJackson等の使用を推奨。
  source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/data_io/data_format.html"
  module:
    group_id: "com.nablarch.framework"
    artifact_id: "nablarch-core-dataformat"
  reference: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/data_io/data_format.html"
  deprecated: true
  migration_guide: "固定長・可変長 → data_bind、XML → Jakarta XML Binding、JSON → Jackson"

  core_classes:
    - name: FormatterFactory
      fqcn: "nablarch.core.dataformat.FormatterFactory"
      description: "フォーマット定義ファイルからDataRecordFormatterを生成するファクトリ"
      verified: true

    - name: DataRecordFormatterSupport
      fqcn: "nablarch.core.dataformat.DataRecordFormatterSupport"
      description: "データレコードフォーマッタの基底クラス"
      verified: true

    - name: FileRecordWriterHolder
      fqcn: "nablarch.common.io.FileRecordWriterHolder"
      description: "ファイルレコード出力管理。ThreadLocalで管理し複数ファイルの同時出力に対応"
      verified: true

    - name: DataRecordResponse
      fqcn: "nablarch.common.web.download.DataRecordResponse"
      description: "データレコードのファイルダウンロード用HTTPレスポンス"

  supported_formats:
    - name: "固定長"
      description: "固定長データ。マルチレイアウト対応"
    - name: "可変長（CSV/TSV）"
      description: "カンマ区切り・タブ区切り等の可変長データ"
    - name: "JSON"
      description: "JSONデータの読み書き"
    - name: "XML"
      description: "XMLデータの読み書き"

  note: |
    data_formatは入出力がMapに限定されており実装誤りを起こしやすい。
    新規開発ではdata_bind（CSV・固定長）やOSSライブラリ（JSON・XML）の使用を推奨。
