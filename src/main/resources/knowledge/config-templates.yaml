# Nablarch Configuration Templates
# XML configuration templates for Nablarch applications.
# Version: 1.0 (Phase 1 Knowledge Base)
# Reference: https://nablarch.github.io/docs/LATEST/doc/

templates:
  # ===== web.xml =====
  - name: web-xml
    category: web-xml
    app_type: web
    description: "Webアプリケーション用 web.xml テンプレート"
    source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/web/architecture.html"
    template: |
      <?xml version="1.0" encoding="UTF-8"?>
      <web-app xmlns="https://jakarta.ee/xml/ns/jakartaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="https://jakarta.ee/xml/ns/jakartaee
                                   https://jakarta.ee/xml/ns/jakartaee/web-app_6_0.xsd"
               version="6.0">

        <!-- Nablarchコンポーネント定義の読み込み -->
        <context-param>
          <param-name>di.config</param-name>
          <param-value>web-boot.xml</param-value>
        </context-param>

        <!-- Nablarch初期化リスナー -->
        <listener>
          <listener-class>nablarch.fw.web.servlet.NablarchServletContextListener</listener-class>
        </listener>

        <!-- Nablarchフロントコントローラ -->
        <filter>
          <filter-name>entryPoint</filter-name>
          <filter-class>nablarch.fw.web.servlet.RepositoryBasedWebFrontController</filter-class>
        </filter>
        <filter-mapping>
          <filter-name>entryPoint</filter-name>
          <url-pattern>/action/*</url-pattern>
        </filter-mapping>

        <!-- セッション設定 -->
        <session-config>
          <session-timeout>30</session-timeout>
        </session-config>

        <!-- エラーページ -->
        <error-page>
          <error-code>404</error-code>
          <location>/WEB-INF/view/common/errorPages/404.jsp</location>
        </error-page>
        <error-page>
          <error-code>500</error-code>
          <location>/WEB-INF/view/common/errorPages/500.jsp</location>
        </error-page>
      </web-app>
    parameters:
      - name: di.config
        description: "コンポーネント定義XMLのパス"
        default: "web-boot.xml"
      - name: url-pattern
        description: "フロントコントローラのURLパターン"
        default: "/action/*"

  - name: rest-web-xml
    category: web-xml
    app_type: rest
    source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/web_service/rest/architecture.html"
    description: "RESTful Webサービス用 web.xml テンプレート"
    template: |
      <?xml version="1.0" encoding="UTF-8"?>
      <web-app xmlns="https://jakarta.ee/xml/ns/jakartaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="https://jakarta.ee/xml/ns/jakartaee
                                   https://jakarta.ee/xml/ns/jakartaee/web-app_6_0.xsd"
               version="6.0">

        <context-param>
          <param-name>di.config</param-name>
          <param-value>rest-boot.xml</param-value>
        </context-param>

        <listener>
          <listener-class>nablarch.fw.web.servlet.NablarchServletContextListener</listener-class>
        </listener>

        <filter>
          <filter-name>entryPoint</filter-name>
          <filter-class>nablarch.fw.web.servlet.RepositoryBasedWebFrontController</filter-class>
        </filter>
        <filter-mapping>
          <filter-name>entryPoint</filter-name>
          <url-pattern>/api/*</url-pattern>
        </filter-mapping>
      </web-app>

  # ===== Component Definition =====
  - name: web-component
    category: component
    app_type: web
    source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/web/architecture.html"
    description: "Webアプリケーション用コンポーネント定義XMLテンプレート"
    template: |
      <?xml version="1.0" encoding="UTF-8"?>
      <component-configuration
          xmlns="http://tis.co.jp/nablarch/component-configuration"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://tis.co.jp/nablarch/component-configuration">

        <!-- 設定ファイル読み込み -->
        <config-file file="common.config" />
        <config-file file="env.config" />

        <!-- 共通コンポーネントの読み込み -->
        <import file="nablarch/webui/web-boot.xml" />

        <!-- ハンドラキュー定義 -->
        <component name="webFrontController"
                   class="nablarch.fw.web.servlet.WebFrontController">
          <property name="handlerQueue">
            <list>
              <component class="nablarch.fw.web.handler.HttpCharacterEncodingHandler">
                <property name="defaultEncoding" value="UTF-8" />
              </component>
              <component class="nablarch.fw.handler.GlobalErrorHandler" />
              <component class="nablarch.fw.web.handler.HttpResponseHandler">
                <property name="contentPath">
                  <component class="nablarch.fw.web.handler.ContentPathRule">
                    <property name="forwardPathPrefix" value="/WEB-INF/view/" />
                    <property name="redirectPathPrefix" value="//" />
                  </component>
                </property>
              </component>
              <component class="nablarch.fw.web.handler.SecureHandler" />
              <component-ref name="multipartHandler" />
              <component-ref name="sessionStoreHandler" />
              <component-ref name="threadContextHandler" />
              <component-ref name="threadContextClearHandler" />
              <component-ref name="dbConnectionManagementHandler" />
              <component-ref name="transactionManagementHandler" />
              <component-ref name="packageMapping" />
            </list>
          </property>
        </component>

        <!-- パッケージマッピング -->
        <component name="packageMapping"
                   class="nablarch.integration.router.RoutesMapping">
          <property name="methodBinderFactory">
            <component class="nablarch.fw.web.handler.HttpMethodBinding$HttpMethodBinderFactory" />
          </property>
          <property name="basePackage" value="com.example.action" />
        </component>
      </component-configuration>

  - name: rest-component
    category: component
    app_type: rest
    source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/web_service/rest/architecture.html"
    description: "RESTful Webサービス用コンポーネント定義XMLテンプレート"
    template: |
      <?xml version="1.0" encoding="UTF-8"?>
      <component-configuration
          xmlns="http://tis.co.jp/nablarch/component-configuration"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://tis.co.jp/nablarch/component-configuration">

        <config-file file="common.config" />
        <config-file file="env.config" />

        <import file="nablarch/webui/web-boot.xml" />

        <!-- RESTハンドラキュー定義 -->
        <component name="webFrontController"
                   class="nablarch.fw.web.servlet.WebFrontController">
          <property name="handlerQueue">
            <list>
              <component class="nablarch.fw.handler.GlobalErrorHandler" />
              <component class="nablarch.fw.jaxrs.JaxRsResponseHandler">
                <property name="errorResponseBuilder">
                  <component class="nablarch.fw.jaxrs.ErrorResponseBuilder" />
                </property>
              </component>
              <component class="nablarch.fw.handler.StatusCodeConvertHandler" />
              <component-ref name="threadContextHandler" />
              <component-ref name="threadContextClearHandler" />
              <component-ref name="dbConnectionManagementHandler" />
              <component-ref name="transactionManagementHandler" />
              <component-ref name="packageMapping" />
            </list>
          </property>
        </component>

        <!-- BodyConverter設定 -->
        <component name="bodyConvertHandler"
                   class="nablarch.fw.jaxrs.BodyConvertHandler">
          <property name="bodyConverters">
            <list>
              <component class="nablarch.integration.jaxrs.jackson.JacksonBodyConverter" />
            </list>
          </property>
        </component>

        <!-- RESTルーティング -->
        <component name="packageMapping"
                   class="nablarch.integration.router.RoutesMapping">
          <property name="methodBinderFactory">
            <component class="nablarch.fw.jaxrs.JaxRsBeanValidationHandlerFactory" />
          </property>
          <property name="basePackage" value="com.example.api" />
        </component>
      </component-configuration>

  - name: batch-component
    category: component
    app_type: batch
    description: "バッチアプリケーション用コンポーネント定義XMLテンプレート"
    source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/batch/nablarch_batch/architecture.html"
    template: |
      <?xml version="1.0" encoding="UTF-8"?>
      <component-configuration
          xmlns="http://tis.co.jp/nablarch/component-configuration"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://tis.co.jp/nablarch/component-configuration">

        <config-file file="common.config" />
        <config-file file="env.config" />

        <!-- バッチハンドラキュー定義 -->
        <component name="multiThreadProcessHandler"
                   class="nablarch.fw.handler.MultiThreadExecutionHandler">
          <property name="concurrentNumber" value="${batch.thread.count}" />
          <property name="handlerQueue">
            <list>
              <!-- サブスレッドのハンドラ -->
              <component-ref name="retryHandler" />
              <component-ref name="dbConnectionManagementHandler" />
              <component class="nablarch.fw.handler.LoopHandler">
                <property name="commitInterval" value="${batch.commit.interval}" />
              </component>
              <component-ref name="transactionManagementHandler" />
              <component class="nablarch.fw.handler.DataReadHandler" />
            </list>
          </property>
        </component>

        <!-- メインスレッドのハンドラキュー -->
        <list name="handlerQueue">
          <component class="nablarch.fw.handler.StatusCodeConvertHandler" />
          <component class="nablarch.fw.handler.GlobalErrorHandler" />
          <component-ref name="dbConnectionManagementHandler" />
          <component-ref name="transactionManagementHandler" />
          <component class="nablarch.fw.handler.RequestPathJavaPackageMapping">
            <property name="basePackage" value="com.example.batch.action" />
          </component>
          <component-ref name="multiThreadProcessHandler" />
        </list>
      </component-configuration>

  - name: messaging-component
    category: component
    app_type: messaging
    description: "テーブルキューイング型メッセージングアプリケーション用コンポーネント定義XMLテンプレート"
    template: |
      <?xml version="1.0" encoding="UTF-8"?>
      <component-configuration
          xmlns="http://tis.co.jp/nablarch/component-configuration"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://tis.co.jp/nablarch/component-configuration">

        <config-file file="common.config" />
        <config-file file="env.config" />

        <!-- メッセージングハンドラキュー定義 -->
        <list name="handlerQueue">
          <component class="nablarch.fw.handler.StatusCodeConvertHandler" />
          <component class="nablarch.fw.handler.GlobalErrorHandler" />
          <component-ref name="dbConnectionManagementHandler" />
          <component-ref name="transactionManagementHandler" />
          <component class="nablarch.fw.handler.RequestPathJavaPackageMapping">
            <property name="basePackage" value="com.example.messaging.action" />
          </component>
          <component class="nablarch.fw.handler.MultiThreadExecutionHandler">
            <property name="concurrentNumber" value="${messaging.thread.count}" />
          </component>
          <component class="nablarch.fw.handler.RequestThreadLoopHandler">
            <property name="serviceUnavailableRetryInterval"
                      value="${messaging.retry.interval}" />
          </component>
          <component-ref name="dbConnectionManagementHandler" />
          <component-ref name="transactionManagementHandler" />
          <component class="nablarch.fw.handler.DataReadHandler" />
        </list>
      </component-configuration>

  # ===== Handler Queue =====
  - name: web-handler-queue
    category: handler-queue
    app_type: web
    description: "Webアプリケーション用ハンドラキュー定義XMLテンプレート"
    template: |
      <!-- Webアプリケーションのハンドラキュー -->
      <property name="handlerQueue">
        <list>
          <!-- 1. 文字エンコーディング -->
          <component class="nablarch.fw.web.handler.HttpCharacterEncodingHandler">
            <property name="defaultEncoding" value="UTF-8" />
          </component>
          <!-- 2. グローバルエラーハンドラ -->
          <component class="nablarch.fw.handler.GlobalErrorHandler" />
          <!-- 3. HTTPレスポンス構築 -->
          <component class="nablarch.fw.web.handler.HttpResponseHandler" />
          <!-- 4. セキュリティヘッダー -->
          <component class="nablarch.fw.web.handler.SecureHandler" />
          <!-- 5. アクセスログ（任意） -->
          <component class="nablarch.common.web.handler.HttpAccessLogHandler" />
          <!-- 6. マルチパート（任意、ファイルアップロード時） -->
          <component class="nablarch.fw.web.upload.MultipartHandler" />
          <!-- 7. セッション管理 -->
          <component-ref name="sessionStoreHandler" />
          <!-- 8. 正規化（任意） -->
          <component class="nablarch.fw.web.handler.NormalizationHandler" />
          <!-- 9. スレッドコンテキスト -->
          <component-ref name="threadContextHandler" />
          <!-- 10. スレッドコンテキストクリア -->
          <component-ref name="threadContextClearHandler" />
          <!-- 11. DB接続管理 -->
          <component-ref name="dbConnectionManagementHandler" />
          <!-- 12. トランザクション管理 -->
          <component-ref name="transactionManagementHandler" />
          <!-- 13. ルーティング -->
          <component-ref name="packageMapping" />
        </list>
      </property>

  # ===== Database =====
  - name: db-connection
    category: database
    source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/database_management.html"
    description: "データベース接続設定テンプレート（コンポーネント定義）"
    template: |
      <!-- データソース設定 -->
      <component name="dataSource"
                 class="nablarch.core.db.connection.BasicDbConnectionFactoryForDataSource">
        <property name="databaseDriverName" value="${db.driver}" />
        <property name="databaseUrl" value="${db.url}" />
        <property name="user" value="${db.user}" />
        <property name="password" value="${db.password}" />
        <property name="maxPoolSize" value="${db.pool.maxSize}" />
        <property name="transactionIsolationLevel"
                  value="READ_COMMITTED" />
      </component>

      <!-- DB接続管理ハンドラ -->
      <component name="dbConnectionManagementHandler"
                 class="nablarch.common.handler.DbConnectionManagementHandler">
        <property name="connectionFactory" ref="dataSource" />
      </component>

      <!-- トランザクション管理ハンドラ -->
      <component name="transactionManagementHandler"
                 class="nablarch.common.handler.TransactionManagementHandler">
        <property name="transactionFactory" ref="jdbcTransactionFactory" />
      </component>

      <component name="jdbcTransactionFactory"
                 class="nablarch.core.db.transaction.JdbcTransactionFactory">
        <property name="isolationLevel" value="READ_COMMITTED" />
        <property name="transactionTimeoutSec" value="0" />
      </component>
    parameters:
      - name: db.driver
        description: "JDBCドライバクラス名"
        default: "org.postgresql.Driver"
      - name: db.url
        description: "JDBC接続URL"
        default: "jdbc:postgresql://localhost:5432/mydb"
      - name: db.user
        description: "データベースユーザー名"
        default: "app_user"
      - name: db.pool.maxSize
        description: "コネクションプール最大サイズ"
        default: "10"

  - name: session-store
    category: database
    app_type: web
    description: "セッションストア設定テンプレート（DBストア）"
    source_url: "https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/session_store.html"
    template: |
      <!-- セッションストアハンドラ -->
      <component name="sessionStoreHandler"
                 class="nablarch.common.web.session.SessionStoreHandler">
        <property name="sessionManager" ref="sessionManager" />
      </component>

      <!-- セッションマネージャ -->
      <component name="sessionManager"
                 class="nablarch.common.web.session.SessionManager">
        <property name="availableStores">
          <list>
            <!-- DBストア -->
            <component class="nablarch.common.web.session.store.DbStore">
              <property name="tableName" value="USER_SESSION" />
              <property name="expirationDateTime" value="1800" />
            </component>
            <!-- HIDDENストア（サブミット間の画面間パラメータ引き継ぎ） -->
            <component class="nablarch.common.web.session.store.HiddenStore" />
          </list>
        </property>
        <property name="defaultStoreName" value="db" />
      </component>

  - name: thread-context
    category: component
    description: "スレッドコンテキスト設定テンプレート"
    template: |
      <!-- スレッドコンテキストハンドラ -->
      <component name="threadContextHandler"
                 class="nablarch.common.handler.threadcontext.ThreadContextHandler">
        <property name="attributes">
          <list>
            <!-- ユーザーID -->
            <component class="nablarch.common.handler.threadcontext.UserIdAttribute">
              <property name="sessionKey" value="user.id" />
              <property name="anonymousId" value="anonymous" />
            </component>
            <!-- リクエストID -->
            <component class="nablarch.common.handler.threadcontext.RequestIdAttribute" />
            <!-- 言語 -->
            <component class="nablarch.common.handler.threadcontext.LanguageAttribute">
              <property name="defaultLanguage" value="ja" />
            </component>
            <!-- 実行時ID -->
            <component class="nablarch.common.handler.threadcontext.ExecutionIdAttribute" />
          </list>
        </property>
      </component>

      <!-- スレッドコンテキストクリアハンドラ -->
      <component name="threadContextClearHandler"
                 class="nablarch.common.handler.threadcontext.ThreadContextClearHandler" />
