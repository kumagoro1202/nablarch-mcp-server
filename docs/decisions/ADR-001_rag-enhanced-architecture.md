# ADR-001: RAG-Enhanced MCPサーバーアーキテクチャの採用

> **ステータス**: 承認済み
> **承認日**: 2026-02-01（cmd_016）
> **起案者**: ashigaru8（O-023作成）
> **承認者**: 殿（上様）

---

## コンテキスト

### 解決すべき課題

Nablarchフレームワークは、TIS株式会社が開発したミッションクリティカルシステム向けJava開発基盤であるが、深刻な情報不足問題を抱えている。

| 指標 | 値 |
|------|-----|
| GitHub Stars | 42（参考: Spring Boot ≈ 76,000） |
| Qiita記事数 | 14 |
| Zenn記事数 | ほぼ0 |
| Stack Overflow | ほぼ0 |

開発者からは「圧倒的、初心者殺しな情報のなさ」（Qiita kirin1218）という声がある。この情報不足により、AIコーディングツール（Claude Code、GitHub Copilot、Cursor等）がNablarch固有の知識（ハンドラキューアーキテクチャ、XML設定方式、独自のDB/トランザクション管理等）を持たず、Nablarch開発でのAI活用効果が限定的になっている。

### 検討した選択肢

Nablarch開発者にAI支援を提供するアーキテクチャとして、以下の3パターンを比較検討した（O-023で詳細分析）。

**パターンA: RAG単体**
- Nablarchのドキュメント・コード・設定をベクトル化し、セマンティック検索で関連情報を取得してLLMに渡す
- 独自アプリケーション（WebUI等）として提供

**パターンB: MCP単体**
- MCPサーバーがNablarchの情報をTools/Resources/Promptsとして公開
- 静的ファイルベースの知識管理

**パターンC: RAG+MCP統合（RAG-enhanced MCP）**
- MCPサーバーの内部にRAGパイプラインを組み込み、セマンティック検索の結果をMCPプロトコルで公開

---

## 決定

**パターンC「RAG-enhanced MCPサーバー」アーキテクチャを採用する。**

MCPサーバーの内部にRAGエンジンを内蔵し、Nablarchの知識ベースに対するセマンティック検索結果を、MCPの標準プロトコル（Tools/Resources/Prompts）を通じてAIコーディングツールに提供する。

```
┌──────────────────────────────────────────────────┐
│        Nablarch MCPサーバー（RAG-enhanced）         │
│                                                   │
│  ┌────────────────────────────────────────┐      │
│  │         MCP Protocol Layer             │      │
│  │  Tools │ Resources │ Prompts           │      │
│  └──────────────────┬─────────────────────┘      │
│                      │                            │
│  ┌──────────────────▼─────────────────────┐      │
│  │         RAGエンジン（内蔵）              │      │
│  │  Embedding │ ハイブリッド検索 │ リランキング│      │
│  └──────────────────┬─────────────────────┘      │
│                      │                            │
│  ┌──────────────────▼─────────────────────┐      │
│  │       Nablarch知識ベース                │      │
│  │  公式Docs │ GitHub 113リポ │ Javadoc    │      │
│  └────────────────────────────────────────┘      │
└──────────────────────────────────────────────────┘
```

実装基盤は **Spring Boot 3.4.x + MCP Java SDK 0.17.x** とする（cmd_016でNablarch実装を断念し、Spring Boot確定済み）。

---

## 根拠

### 1. 7ユースケース全てでRAG+MCP統合が単体を上回る（O-023分析結果）

O-023では、Nablarch開発支援の7つのユースケースについて、3パターンの有効性を評価した。

| ユースケース | RAG貢献度 | MCP貢献度 | 統合効果 |
|-------------|:---------:|:---------:|:-------:|
| ハンドラキュー自動設計 | ★★★★★ | ★★★★☆ | **極高** |
| コード生成 | ★★★★☆ | ★★★★★ | **極高** |
| トラブルシューティング | ★★★★★ | ★★★☆☆ | **高** |
| 学習支援 | ★★★★★ | ★★★☆☆ | **高** |
| コードレビュー | ★★★★☆ | ★★★★☆ | **極高** |
| マイグレーション支援 | ★★★★★ | ★★★☆☆ | **高** |
| テスト生成 | ★★★★☆ | ★★★★★ | **極高** |

**分析結論**: RAGはすべてのユースケースで「知識提供」として不可欠。MCPは「ツール実行」が求められるユースケース（コード生成、テスト生成、バリデーション）で特に貢献度が高い。両者を統合することで、すべてのユースケースで単体を上回る効果が得られる。

### 2. 3パターン比較での定量的優位性（O-023 セクション3.4）

| 評価観点 | RAG単体 | MCP単体 | RAG+MCP統合 |
|---------|---------|---------|------------|
| 検索精度 | ◎ | △ | **◎** |
| AIツール統合 | △ | ◎ | **◎** |
| ツール実行 | ✗ | ◎ | **◎** |
| 大量知識対応 | ◎ | △ | **◎** |
| セキュリティ | △ | ◎ | **◎** |
| Nablarch適性 | ○ | ○ | **◎** |

RAG+MCP統合は10項目中8項目で最高評価を獲得し、残り2項目（開発コスト・保守性）でも許容範囲内。

### 3. 学術的エビデンス（arXiv:2505.03275）

RAG-MCP論文（arXiv:2505.03275）は、RAGによるMCPツール選択の最適化を実証している。

- **プロンプトトークン75%削減**: RAGでMCPツールのメタデータを検索し、関連ツールのみをLLMに提示
- **精度3倍向上**: セマンティックなツール選択により、関連性の高いツールのみがLLMに渡される

### 4. RAGとMCPの補完関係の明確化（O-023 セクション2）

O-023は両技術の関係を以下のように整理した。

| 技術 | 役割 | 情報フロー | 強み | 弱み |
|------|------|----------|------|------|
| **RAG** | AIが「知る」仕組み | バッチ取得型（質問→検索→一括取得） | 大量ドキュメントの高精度検索 | AIツールとの標準統合手段なし |
| **MCP** | AIが「使う」仕組み | オンデマンド型（反復的リクエスト） | 標準プロトコル、ツール実行 | 大量知識の効率的検索機構なし |
| **RAG+MCP** | AIが「知って使う」仕組み | 両方を統合 | 知識検索+ツール実行+標準プロトコル | 開発コスト高（両方の構築） |

MCPが「外殻」（AIツールとの標準インターフェース）、RAGが「頭脳」（知識検索エンジン）として機能する。

### 5. Spring Boot確定によるRAG統合の自然さ（cmd_016、O-022）

cmd_016でNablarch上でのMCPサーバー実装を断念し、Spring Bootで確定した。O-022の調査結果により:

- NablarchにはSSE/リアクティブ/ノンブロッキングのネイティブサポートがない
- MCPサーバーのトランスポート層にNablarchを使う技術的必要性がない
- Spring Bootエコシステム上であれば、pgvector + Embeddingパイプライン等のRAG技術スタックとの統合が自然

---

## 結果（予想される影響）

### ポジティブな影響

| 影響 | 詳細 |
|------|------|
| **AIツール精度の大幅向上** | セマンティック検索により、Nablarch固有の知識を高精度で提供 |
| **標準プロトコルによる広範な互換性** | Claude Desktop、Claude Code、Copilot、Cursor等の主要AIツールに対応 |
| **ツール実行と知識検索の統合** | ハンドラキュー検証・コード生成等のツールがRAGの知識を活用 |
| **段階的な拡張が可能** | Phase 1（MCP基盤）→ Phase 2（RAG統合）と段階的に構築可能 |

### ネガティブな影響・リスク

| 影響 | 対策 |
|------|------|
| **実装複雑度の増加** | Phase 1でMCP基盤を先行構築し、Phase 2でRAGを追加する段階的アプローチ |
| **ベクトルDB管理の必要性** | PostgreSQL + pgvectorを採用し、運用コストを最小化 |
| **インデックス更新の運用コスト** | GitHub Webhook連携による自動更新パイプラインを Phase 4 で構築 |
| **開発コストがMCP単体より高い** | RAGの効果が7ユースケースで実証済みであり、投資対効果は十分 |
| **レイテンシの増加** | RAG検索は100-300ms程度。キャッシュ戦略とTop-K制限で制御 |

---

## 代替案の検討

### パターンA: RAG単体 — 不採用

**理由:**
- AIツール（Claude Code等）との標準的な統合手段がない。独自APIの構築が必要
- ツール実行（ハンドラキュー検証、コード生成等）ができない
- MCPの標準プロトコルが業界標準として確立されつつあり、独自APIは将来的に不利

**O-023の評価**: 「知識提供に強いが、AIツール統合が△」

### パターンB: MCP単体 — 不採用

**理由:**
- 大量のNablarchドキュメント（公式Docs数百ページ、GitHub 113リポジトリ、全Javadoc）を静的ファイルベースで管理するのは非効率
- キーワード検索のみでは、ユーザーの意図に合致した情報を取得する精度が不十分
- Nablarchの情報不足問題の根本解決（セマンティック検索による高精度な知識提供）ができない

**O-023の評価**: 「ツール提供に強いが、検索精度が△、大量知識対応が△」

### Nablarchハンドラキュー統合 — 不採用（cmd_016で決定済み）

O-022の調査により、NablarchにはSSE/リアクティブの根本的な不足があり、MCPプロトコルのStreamable HTTPトランスポート実装が困難。ハンドラキューの直列パイプラインモデルとJSON-RPC 2.0の双方向メッセージングは根本的に異なる。

---

## 関連文書

| 文書 | パス | 内容 |
|------|------|------|
| **O-023: RAG×MCP関連性分析** | [research/O-023_nablarch_rag_mcp_analysis.md](../research/O-023_nablarch_rag_mcp_analysis.md) | 本ADRの主要根拠。3パターン比較、7ユースケース分析、推奨アーキテクチャ |
| **アーキテクチャ設計書** | [architecture.md](../architecture.md) | RAG-enhanced MCPサーバーの技術設計 |
| **O-022: MCP実装可能性調査** | output/O-022_nablarch_mcp_feasibility_study.md | Nablarch実装断念の技術的根拠。Spring Boot確定の経緯 |
| **O-001: MCPサーバー構築計画** | output/O-001_nablarch_mcp_server_plan.md | 元の構築計画。技術スタック、ロードマップ、リスク分析 |
| **O-010: コミュニティ分析** | output/O-010_nablarch_kb_community.md | Nablarchの情報不足問題の定量的根拠 |

---

*本ADRは、O-023（RAGとMCPの関連性分析レポート）の分析結果に基づき作成された。*
